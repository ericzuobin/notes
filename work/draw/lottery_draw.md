##<center>开派奖改造

- 版本历史

	日 期|版 本|说 明|作 者
	:---:|:---:|:---:|:---:
	2015/10/29|1.0|初版|左彬


###一、背景原因
- 开派奖现有处理逻辑：

	目前处理方式为主线程获取开奖任务，根据彩种和彩期、方案生成的时间段(最后一个方案生成时间-第一个方案时间)的时间作平均切分之后进行查询，再平均分发到各开派奖子线程。

- 影响性能主要的因素
	
	1. 单个主线程查询方案，分发子线程处理的同步方式，处理能力有限。
	2. 开奖任务只能部署在一台Server上进行，不能通过增加机器来提升吞吐量。
	3. 开奖主线程处理进度的阻塞操作，依赖于子线程任务处理的成功数和失败数，可能会卡住主线程。
	4. 开奖算法时间的消耗
- 影响性能次要的因素	
	1. 数据库读写时间的消耗
	2. API请求时间的消耗
	
###二、改造概要
- Engine此次涉及改造

	1. 改造主要影响开派奖性能的因素，改造开派奖处理逻辑和架构，同步操作改为异步操作。
	2. 开奖算法由于涉及基本格式，影响拆票和PHP相关格式，范围涉及大，可后期改造。
	3. 数据库与API消耗影响相对小，涉及PHP，同时API消耗不单只是开派奖，可后期改造。
	
###三、相关人员
- 负责此次改造的人员分工如下：

	姓名|角色|工作描述
	:---:|:----:|:---:
	朱少青|项目负责人|项目进度跟踪、管理
	左彬、杨靖宇|业务开发|负责设计、改造相关内容
	郑晓红|QA测试|QA测试以及进度跟踪
	
	
###四、实施计划
- 系统设计
	1. 时间期限:2015/10/30~2015/11/6
	2. 完成对开派奖的分析设计，对设计改造的逻辑处理，功能模块进行分析与设计。
	3. 保留目前的开派奖功能，新增功能为新开奖功能
	
- 编码阶段
	1. 时间期限:2015/11/9~2015/11/27
	2. 完成对开派奖的改造的编码工作
	
- 测试阶段
	1. 时间期限：2015/11/30~2015/12/11
	2. 完成对开派奖改造的测试     

###五、具体改造(概要)
- 与Admin相关
	1. 队列需改造：由于考虑到暂时要保留原有的开派奖功能，新开派奖功能与原有功能共同存在一段时间。所以开派奖接收任务的队列需要区分开

	2. Admin后台界面增加异步开奖的处理页。
	3. Admin后台查询异步开奖进度的接口需改造。
	
- 流程图	

![alt text](http://7xnwn3.com1.z0.glb.clouddn.com/draw.png =380x508 "title")
	
- 开派奖功能详解
	1. 开奖线程查询出方案生成时间段T(最后一个方案生成时间-第一个方案时间)
	2. 查询出待开奖彩种、彩期下总的方案数，供查询进度处理用。
	3. 获取开奖结果等数据，更新缓存，等候异步开奖Listener处理。
	4. 根据彩种不同，对方案生成时间段作切分时间处理。比如切分成12份，切分时间是T1=T/12
	5. 异步查询线程查询每个T1时间段下的方案总数，比较该T1时间段下方案总数和预设值(暂定500，可调整)
	6. 如果T1时间段方案总数小于预设值，直接扔MQ等候异步开奖Listener处理。
	7. 如果T1时间段方案总数大于等于预设值，递归的对该时间段进行拆分。直到所有时间段的方案数都小于预设值。扔MQ等候异步开奖Listener处理。
	8. 缓存处理，将待开奖方案数，时间段等内容缓存，供进度处理和主开奖线程阻塞用。
	9. 异步Listener接收MQ消息，分发到查询子线程(线程数可调)，将每个方案查询处理之后，放本地队列，分发到开奖子线程(线程数可调)，Listener阻塞等待。
	9. 进行开奖算法处理，处理完之后,发送异步队列更新票和订单。
	9. 当Listener下所有子线程都处理完成之后，调用PHP的API更新PHP的方案，同时更新缓存，供开奖进度查询用。
	9. 开奖线程发现所有队列都更新处理完之后，开奖结束，缓存删除等处理。
